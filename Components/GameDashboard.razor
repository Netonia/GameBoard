@using LumexUI
@inject DashboardService DashboardService

<div class="container mx-auto px-4 mb-8">
    <h2 class="text-2xl font-bold mb-6">Tableau de bord</h2>
    
    @if (_loading)
    {
        <div class="flex justify-center items-center h-32">
            <div class="text-lg">Chargement des statistiques...</div>
        </div>
    }
    else if (_stats != null)
    {
        <!-- Key Statistics Cards -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
            <div class="bg-white rounded-lg shadow-md p-6 text-center">
                <div class="text-3xl font-bold text-blue-600">@_stats.TotalGames</div>
                <div class="text-sm text-gray-600">Jeux au total</div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 text-center">
                <div class="text-3xl font-bold text-green-600">@_stats.AverageRating.ToString("F1")</div>
                <div class="text-sm text-gray-600">Note moyenne</div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 text-center">
                <div class="text-3xl font-bold text-red-600">@_stats.FavoriteGames</div>
                <div class="text-sm text-gray-600">Favoris</div>
            </div>
            
            <div class="bg-white rounded-lg shadow-md p-6 text-center">
                <div class="text-3xl font-bold text-purple-600">@_stats.PlatformDistribution.Count</div>
                <div class="text-sm text-gray-600">Plateformes</div>
            </div>
        </div>

        <!-- Charts and Distribution -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
            <!-- Platform Distribution -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">Répartition par plateforme</h3>
                <div class="space-y-3">
                    @{
                        var maxCount = _stats.PlatformDistribution.Values.Max();
                    }
                    @foreach (var platform in _stats.PlatformDistribution.OrderByDescending(p => p.Value))
                    {
                        var percentage = maxCount > 0 ? (double)platform.Value / maxCount * 100 : 0;
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium">@platform.Key</span>
                            <div class="flex items-center space-x-2">
                                <div class="w-32 bg-gray-200 rounded-full h-2">
                                    <div class="bg-blue-600 h-2 rounded-full" style="width: @(percentage)%"></div>
                                </div>
                                <span class="text-sm text-gray-600 w-8">@platform.Value</span>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Genre Distribution -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">Répartition par genre</h3>
                <div class="space-y-3">
                    @{
                        var maxGenreCount = _stats.GenreDistribution.Values.Max();
                    }
                    @foreach (var genre in _stats.GenreDistribution.OrderByDescending(g => g.Value))
                    {
                        var percentage = maxGenreCount > 0 ? (double)genre.Value / maxGenreCount * 100 : 0;
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium">@genre.Key</span>
                            <div class="flex items-center space-x-2">
                                <div class="w-32 bg-gray-200 rounded-full h-2">
                                    <div class="bg-green-600 h-2 rounded-full" style="width: @(percentage)%"></div>
                                </div>
                                <span class="text-sm text-gray-600 w-8">@genre.Value</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <!-- Recent and Top Games -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
            <!-- Recent Games -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">Sorties récentes</h3>
                <div class="space-y-4">
                    @foreach (var game in _stats.RecentGames)
                    {
                        <div class="flex items-center space-x-3">
                            <img src="@game.ImageUrl" alt="@game.Title" class="w-12 h-16 object-cover rounded" />
                            <div class="flex-1">
                                <div class="font-medium">@game.Title</div>
                                <div class="text-sm text-gray-600">@game.Platform • @game.ReleaseDate.ToString("MMM yyyy")</div>
                            </div>
                            <div class="flex items-center">
                                <svg class="w-4 h-4 text-yellow-400 fill-current mr-1" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                                <span class="text-sm">@game.Rating.ToString("F1")</span>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <!-- Top Rated Games -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-lg font-semibold mb-4">Meilleures notes</h3>
                <div class="space-y-4">
                    @foreach (var game in _stats.TopRatedGames)
                    {
                        <div class="flex items-center space-x-3">
                            <img src="@game.ImageUrl" alt="@game.Title" class="w-12 h-16 object-cover rounded" />
                            <div class="flex-1">
                                <div class="font-medium">@game.Title</div>
                                <div class="text-sm text-gray-600">@game.Platform • @game.Genre</div>
                            </div>
                            <div class="flex items-center">
                                <svg class="w-4 h-4 text-yellow-400 fill-current mr-1" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                                <span class="text-sm font-bold">@game.Rating.ToString("F1")</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    }
</div>

@code {
    private DashboardStats? _stats;
    private bool _loading = true;

    [Parameter] public List<Game>? FilteredGames { get; set; }

    protected override async Task OnInitializedAsync()
    {
        await LoadStats();
    }

    protected override async Task OnParametersSetAsync()
    {
        await LoadStats();
    }

    private async Task LoadStats()
    {
        _loading = true;
        _stats = await DashboardService.GetDashboardStatsAsync(FilteredGames);
        _loading = false;
        StateHasChanged();
    }
}